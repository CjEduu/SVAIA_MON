{% extends "layout.html" %}

{% block content %}
<div class="container mt-1" style="padding-top: 80px; padding-bottom: 120px;">
    <div class="mx-auto" style="max-width: 600px;">
        <div class="card shadow-lg border-0">
            <div class="card-body p-4">
                <h2 class="text-center mb-4 fw-bold text-primary">
                    <i class="bi bi-folder-plus me-2"></i>Nuevo Proyecto
                </h2>
                <form id="formCrearProyecto" enctype='multipart/form-data'>
                    <div class="mb-3">
                        <label for="nombre" class="form-label fs-5 fw-semibold text-secondary">
                            <i class="bi bi-card-text me-1"></i>Nombre
                        </label>
                        <input type="text" name="nombre" class="form-control" required placeholder="Nombre del proyecto">
                    </div>
                    <div class="mb-3">
                        <label for="descripcion" class="form-label fs-5 fw-semibold text-secondary">
                            <i class="bi bi-info-circle me-1"></i>Descripción
                        </label>
                        <textarea id="descripcion" name="descripcion" class="form-control" rows="4" placeholder="Opcional..."></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="nivelCVSS" class="form-label fs-5 fw-semibold text-secondary">
                            <i class="bi bi-shield-lock me-1"></i>Puntuación CVSS v3.1 máxima aceptable
                        </label>
                        <select class="form-select" id="nivelCVSS" name="nivelCVSS" type="number">
                            <option>1</option>
                            <option>2</option>
                            <option>3</option>
                            <option>4</option>
                            <option>5</option>
                            <option>6</option>
                            <option>7</option>
                            <option>8</option>
                            <option>9</option>
                            <option>10</option>
                        </select>
                    </div>
                    <h4 class="my-4 text-center text-info fw-bold">
                        <i class="bi bi-bar-chart-steps me-2"></i>Niveles máximos de impacto sobre:
                    </h4>
                    <div class="mb-3">
                        <label for="nivelIntegridad" class="form-label fw-semibold">
                            <i class="bi bi-patch-check me-1 text-success"></i>Integridad
                        </label>
                        <select class="form-select" id="nivelIntegridad" name="nivelIntegridad">
                            <option>NONE</option>
                            <option>LOW</option>
                            <option>MEDIUM</option>
                            <option>HIGH</option>
                            <option>CRITICAL</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="nivelConfidencialidad" class="form-label fw-semibold">
                            <i class="bi bi-eye-slash me-1 text-warning"></i>Confidencialidad
                        </label>
                        <select class="form-select" id="nivelConfidencialidad" name="nivelConfidencialidad">
                            <option>NONE</option>
                            <option>LOW</option>
                            <option>MEDIUM</option>
                            <option>HIGH</option>
                            <option>CRITICAL</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="nivelDisponibilidad" class="form-label fw-semibold">
                            <i class="bi bi-wifi-off me-1 text-danger"></i>Disponibilidad
                        </label>
                        <select class="form-select" id="nivelDisponibilidad" name="nivelDisponibilidad">
                            <option>NONE</option>
                            <option>LOW</option>
                            <option>MEDIUM</option>
                            <option>HIGH</option>
                            <option>CRITICAL</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="sbomFile" class="form-label fs-5 fw-semibold text-secondary">
                            <i class="bi bi-file-earmark-arrow-up me-1"></i>SBOM
                        </label>
                        <input class="form-control" type="file" id="sbomFile" name="sbomFile" required>
                    </div>
                    <div class="d-flex gap-2 justify-content-center">
                        <button id="crearBtn" type="submit" class="btn btn-success px-4">
                            <span id="crearBtnText"><i class="bi bi-check-circle me-1"></i>Crear</span>
                            <span id="crearBtnSpinner" style="display:none;">
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                Cargando...
                            </span>
                        </button>
                        <a href="{{ url_for('index') }}" class="btn btn-secondary px-4"><i class="bi bi-x-circle me-1"></i>Cancelar</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>

 function parseFile(file){
  return new Promise((resolve, reject) => {
      const fileReader = new FileReader();
      fileReader.onload = (evt) => {
        try {
          const json = JSON.parse(evt.target.result);
          resolve(json);
        } catch (e) {
          reject(e);
        }
      };
      fileReader.onerror = () => reject(fileReader.error);
      fileReader.readAsText(file);
    });
  };
  
async function crearProyecto(event) {
    event.preventDefault();  // Evita el envío tradicional del formulario
    // Show spinner, hide text
    document.getElementById('crearBtnText').style.display = 'none';
    document.getElementById('crearBtnSpinner').style.display = 'inline-block';
    document.getElementById('crearBtn').disabled = true;

    const formData = new FormData(event.target);  // Recoge todos los datos del formulario
    const sbomFile = formData.get('sbomFile');
    const sbomText = await parseFile(sbomFile);

    // Realizamos una solicitud POST al backend para crear el nuevo proyecto
    fetch("http://127.0.0.1:4447/api/proyectos/crear", {
      method: "POST",
      credentials:'include',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        nombre: formData.get("nombre"),
        descripcion: formData.get("descripcion"),
        nivelCVSS: formData.get("nivelCVSS"),
        nivelIntegridad: formData.get("nivelIntegridad"),
        nivelConfidencialidad: formData.get("nivelConfidencialidad"),
        nivelDisponibilidad: formData.get("nivelDisponibilidad"),
        sbom: sbomText
      })
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(errorData => {
          throw new Error(errorData.error || "Error al crear el proyecto");
        });
      }
      return response.json();
    })
    .then(data => {
      // Obtener el valor de "next" desde la URL actual
      const params = new URLSearchParams(window.location.search);
      const next = params.get("next") || "{{ url_for('proyectos') }}";
      
      // Redirigir al destino adecuado
      window.location.href = next;
    })
    .catch(error => {
      alert("Error: " + error.message);  // Muestra errores si ocurren
    })
    .finally(() => {
      // Restore button if needed (optional, since usually we redirect)
      document.getElementById('crearBtnText').style.display = 'inline';
      document.getElementById('crearBtnSpinner').style.display = 'none';
      document.getElementById('crearBtn').disabled = false;
    });
  }

  document.getElementById('formCrearProyecto').addEventListener('submit', crearProyecto);
</script>

{% endblock %}


