{% extends "layout.html" %}

{% block content %}
<div class="container mt-5" style="padding-top: 80px; padding-bottom: 120px;">
  <div class="mx-auto" style="max-width: 600px;">
    <div class="card shadow-lg border-0">
      <div class="card-body p-4">
        <h2 class="text-center mb-4 fw-bold text-primary">
          <i class="bi bi-pencil-square me-2"></i>Editar Proyecto
        </h2>
        <form id="formEditar" onsubmit="editarProyecto(event)">
          <input type="hidden" name="nombre_original" value="{{ proyecto.nombre }}">

          <div class="mb-3">
            <label for="nombre" class="form-label fs-5 fw-semibold text-secondary">
              <i class="bi bi-kanban-fill me-1"></i>Nuevo Nombre del Proyecto
            </label>
            <input type="text" id="nombre" name="nombre" class="form-control" value="{{ proyecto.nombre }}" required>
          </div>

          <div class="mb-3">
            <label for="owner" class="form-label fs-5 fw-semibold text-secondary">
              <i class="bi bi-person-circle me-1"></i>Nuevo Propietario
            </label>
            <input type="text" id="owner" name="owner" class="form-control" value="{{ proyecto.owner }}" required>
          </div>

          <div class="mb-3">
            <label for="descripcion" class="form-label fs-5 fw-semibold text-secondary">
              <i class="bi bi-card-text me-1"></i>Descripci칩n
            </label>
            <textarea id="descripcion" name="descripcion"
              class="form-control" rows="4" placeholder="Describe el proyecto...">{{ proyecto.descripcion }}</textarea>
          </div>
          
          <div class="mb-4">
            <label for="nivelCVSS" class="form-label fs-5 fw-semibold text-secondary">
              <i class="bi bi-shield-lock me-1"></i>Puntuaci칩n CVSS v3.1 m치xima aceptable
            </label>
            <select class="form-select" id="nivelCVSS" name="nivelCVSS" type="number" selected="{{ sec_info.nivelCSS }}">
              <option>1</option>
              <option>2</option>
              <option>3</option>
              <option>4</option>
              <option>5</option>
              <option>6</option>
              <option>7</option>
              <option>8</option>
              <option>9</option>
              <option>10</option>
            </select>
          </div>

          <h4 class="my-4 text-center text-info fw-bold">
            <i class="bi bi-bar-chart-steps me-2"></i>Niveles m치ximos de impacto sobre:
          </h4>
          <div class="mb-3">
            <label for="nivelIntegridad" class="form-label fw-semibold">
              <i class="bi bi-patch-check me-1 text-success"></i>Integridad
            </label>
            <select class="form-select" id="nivelIntegridad" name="nivelIntegridad">
              <option>NONE</option>
              <option>LOW</option>
              <option>MEDIUM</option>
              <option>HIGH</option>
              <option>CRITICAL</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="nivelConfidencialidad" class="form-label fw-semibold">
              <i class="bi bi-eye-slash me-1 text-warning"></i>Confidencialidad
            </label>
            <select class="form-select" id="nivelConfidencialidad" name="nivelConfidencialidad">
              <option>NONE</option>
              <option>LOW</option>
              <option>MEDIUM</option>
              <option>HIGH</option>
              <option>CRITICAL</option>
            </select>
          </div>

          <div class="mb-4">
            <label for="nivelDisponibilidad" class="form-label fw-semibold">
              <i class="bi bi-wifi-off me-1 text-danger"></i>Disponibilidad
            </label>
            <select class="form-select" id="nivelDisponibilidad" name="nivelDisponibilidad">
              <option>NONE</option>
              <option>LOW</option>
              <option>MEDIUM</option>
              <option>HIGH</option>
              <option>CRITICAL</option>
            </select>
          </div>
          <div class="mb-4">
            <label for="sbomFile" class="form-label fs-5 fw-semibold text-secondary">
              <i class="bi bi-file-earmark-arrow-up me-1"></i>SBOM
            </label>
            <input class="form-control" type="file" id="sbomFile" name="sbomFile" required>
          </div>
          <div class="d-flex gap-2 justify-content-center">
            <button type="submit" class="btn btn-primary px-4"><i class="bi bi-save me-1"></i>Guardar Cambios</button>
            <a href="{{ url_for('proyectos') }}" class="btn btn-secondary px-4"><i class="bi bi-x-circle me-1"></i>Cancelar</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  function editarProyecto(event) {
    event.preventDefault();
  
    const formData = new FormData(event.target);
    console.log(formData.get("nombre_original"));

    // TODO 
    // Como huele esto a vulnerabilidad LMAO un path traversal manual cambiando el atributo hidden
    // TODO
    // Mandar el SBOM distinto
    // TODO NO HARDCODEAR API ENDPOINT
    fetch(`http://127.0.0.1:4447/api/proyectos/editar/${formData.get("nombre_original")}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      credentials: 'include',
      body: JSON.stringify({
        nombre: formData.get("nombre"),
        owner: formData.get("owner"),
        descripcion: formData.get("descripcion"),
        nivelCVSS: formData.get("nivelCVSS"),
        nivelIntegridad: formData.get("nivelIntegridad")   ,
        nivelConfidencialidad: formData.get("nivelConfidencialidad")    ,
        nivelDisponibilidad : formData.get("nivelDisponibilidad")
      })
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(errorData => {
          throw new Error(errorData.error || "Error al editar el proyecto");
        });
      }
      return response.json();
    })
    .then(data => {
      window.location.href = "{{ url_for('proyectos') }}";  // Redirige a la lista de proyectos
    })
    .catch(error => {
      alert("Error: " + error.message);
    });
  }
  
</script>
{% endblock %}
